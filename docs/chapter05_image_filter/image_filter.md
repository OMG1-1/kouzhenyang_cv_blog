# 图像滤波

## 概念

即在尽量保留图像细节特征的条件下对目标图像的噪声进行抑制，是图像预处理中不可缺少的操作，其处理效果的好坏将直接影响到后续图像处理和分析的有效性和可靠性。

## 目的

1. 消除图像中混入的噪声
2. 为图像识别抽取出图像特征

## 要求

1. 不能损坏图像轮廓及边缘
2. 图像视觉效果应当比处理前更好

## 平滑化与滤波操作

消除图像中的噪声成分叫作图像的平滑化或滤波操作。信号或图像的能量大部分集中在幅度谱的低频和中频段是很常见的，而在较高频段，感兴趣的信息经常被噪声淹没。因此一个能降低高频成分幅度的滤波器就能够减弱噪声的影响。

## 平滑滤波

平滑滤波是低频增强的空间域滤波技术。它的目的有两类:一类是模糊;另一类是消除噪音。空间域的平滑滤波一般采用简单平均法进行，就是求邻近像元点的平均亮度值。邻域的大小与平滑的效果直接相关，邻域越大平滑的效果越好，但邻域过大，平滑会使边缘信息损失的越大，从而使输出的图像变得模糊，因此需合理选择邻域的大小。

## 滤波器

一种形象的比喻法是:我们可以把滤波器想象成一个包含加权系数的窗口，当使用这个滤波器平滑处理图像时，就把这个窗口放到图像之上，透过这个窗口来看我们得到的图像。

### 线性滤波

图像处理最基本的方法，允许对图像进行各种处理，从而产生很多不同的效果。

### 均值滤波

是图像处理中最常用的手段，从频率域观点来看均值滤波是一种低通滤波器，高频信号将会去掉，因此可以帮助消除图像尖锐噪声，实现图像平滑，模糊等功能。理想的均值滤波是用每个像素和它周围像素计算出来的平均值替换图像中每个像素。

#### 公式

$g(x,y)=\frac{1}{M}\sum_{f \in s}f(x,y)$

#### 特性

● 从左到右再从上到下计算图像中的每个像素，最终得到处理后的图像。
● 均值滤波可以加上两个参数，即迭代次数，Kernel 数据大小
○ 一个相同的 Kernel，多次迭代，效果越好
○ 迭代次数相同，Kernel 矩阵越大，效果越好

注意：这个 kernel 加权求和后再除 9 才是均值，用均值替换中心像素

#### 优点

算法简单，计算速度快

#### 缺点

降低噪声的同时使图像产生模糊，特别是景物的边缘和细节部分

### 中指滤波

中值滤波也是消除图像噪声最常见的手段之一，特别是消除椒盐噪声，中值滤波的效果要比均值滤波更好。中值滤波跟均值滤波唯一不同是，不是用均值来替换中心每个像素，而是将周围像素和中心像素排序以后，取中值。
一个 3X3 大小的中值滤波如下:

#### 优点

抑制效果很好，画面的清晰度基本保持

#### 缺点

对高斯噪声的一直效果不是很好

### 最大最小值滤波

最大最小值滤波是一种比较保守的图像处理手段，与中指滤波类似，首先要排序周围像素和中心像素值，然后将中心像素值与最小和最大像素值比较，如果比最小值小，则替换中心像素为最小值，如果中心像素比最大值大，则替换中心像素为最大值。
一个 Kernel 矩阵为 3\*3 的最大最小值滤波如下：

### 引导滤波

在引导滤波的定义中，会用到局部线性模型。

#### 局部线性模型

该模型认为，某函数上一点与其临近部分的点成线性关系，一个复杂的函数就可以用很多局部的线性函数来表示，当需要求该函数上某一点的值时，只需计算所有包含该点的线性函数的值并做平均即可。这种模型在表示非解析函数上非常有用。

##### 扩展

可以认为图像是一个二维函数，而且没法写出解析表达式，因此我们假设该函数的输出与输入在一个二维窗口内满足线性关系：
$q_i=a_kI_i+b_k,i \in \omega_k$，
其中$q$是输出像素的值，$I$是输入图像的值，$i$和$k$是像素索引，$a$和$b$是当窗口中心位于$k$时该线性函数的系数。

其实，输入图像不一定是待滤波的图像本身，也可以是其他图像即引导图像，这也是为何称为引导滤波的原因。对上式两边取梯度，可以得到：
$\nabla q=a \nabla I$，
即当输入图像$I$有梯度时，输出$q$也有类似的梯度，现在可以解释为什么引导滤波有边缘保持特性了。

下一步就是求出线性函数的系数，也就是线性回归，即希望拟合函数的输出值与真实值$p$之间的差距最小，也就是让下式最小：
$E(a_k,b_k)= \sum_{i \in \omega_k}((a_kI_i+b_k-p_i)^2+ \epsilon a_k^2).$
这里$p$只能是待滤波的图像，并不像$I$那样可以是其他图像。同时，$\epsilon$用于防治求的$a$过大，也是调节滤波器滤波效果的重要参数。通过最小二乘法，可以得到：
$a_k=\dfrac{\dfrac{1}{\left| \omega \right|}\sum_{i \in \omega_k}I_ip_i- \mu_k \bar{p}_k}{a_k^2+ \epsilon}$
其中，$\omega_k$是窗口，$\mu_k$是$I$在窗口中的平均值，$a_k^2$是$I$在窗口中的方差，$\left| \omega \right|$是窗口中的像素数量，$\bar{p}_k$是待滤波图像$p$在窗口中的均值。
$b_k=\bar{p}_k-a_k \mu_k$
其中，$\mu_k$是$I$在窗口中的平均值，$\bar{p}_k$是待滤波图像$p$在窗口中的均值。

在计算每个窗口的线性系数时，我们可以发现一个像素会被多个窗口包含，也就是说，每个像素都由多个线性函数所描述。因此，如之前所说，要具体求某一点的输出值时，只需将所有包含该点的线性函数平均即可：
$\begin{aligned}
q_i
&= \dfrac{1}{\left| \omega \right|} \sum_{k:i \in \omega_k}(a_kIi+b_k) \\
&= \bar{a}_iI_i+\bar{b}_i
\end{aligned}$
这里，$\omega_k$是所有包含像素$i$的窗口，$k$是其中心位置。

当把引导滤波用作边缘保持滤波器时，往往有 $I=p$，如果$\epsilon=0$，显然$a=1$,$b=0$ 是$E(a,b)$为最小值的解， 从上式可以看出，这时的滤波器没有任何作用，将输入原封不动的输出。如果$\epsilon \gt 0$，在像素强度变化小的区域(或单色区域)，有$a$近似于(或等于)0，而$b$近似于(或等于)，即做了一个加权均值滤波; 而在变化大的区域，$a$近似于 1，$b$近似于 0，对图像的滤波效果很弱，有助于保持边缘。而$\epsilon$的作用就是界定什么是变化大，什么是变化小。在窗口大小不变的情况下，随着$\epsilon$的增大，滤波效果越明显。

#### 引导滤波和双边滤波

在滤波效果上，引导滤波和双边滤波差不多，在一些细节上，引导滤波较好。
引导滤波最大的优势在于，可以写出时间复杂度与窗口大小无关的算法，因此在使用大窗口处理图片时，其效率更高。
